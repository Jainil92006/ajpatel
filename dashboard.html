<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - AJ Patel & Moksha Mistry Association</title>
   <style>
    :root {
      --primary: #00d9ff;
      --accent: #0072ff;
      --bg: #101820;
      --card-bg: #1a1a2e;
      --border: #2d2d2d;
      --text: #ffffff;
      --muted: #b0b0b0;
      --highlight: #00ffc3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding-top: 90px;
      line-height: 1.6;
    }

    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      background: linear-gradient(to right, var(--primary), var(--accent));
      padding: 25px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      z-index: 999;
    }

    .brand {
      font-size: 26px;
      font-weight: 700;
    }

    .subtitle {
      margin-right: 1000px;
      font-size: 14px;
      color: #f2f2f2;
    }

    .nav-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .nav-links {
      display: flex;
      gap: 16px;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-size: 17px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 6px;
      transition: 0.3s ease;
    }

    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 40px 20px;
    }

    h2, h3 {
      text-align: center;
      color: var(--highlight);
      margin-bottom: 20px;
      position: relative;
    }

    h2::after, h3::after {
      content: "";
      position: absolute;
      width: 50px;
      height: 3px;
      background: var(--accent);
      left: 50%;
      transform: translateX(-50%);
      bottom: -10px;
    }

    form {
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
      max-width: 600px;
      margin: 0 auto 40px;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border: none;
      border-radius: 6px;
      background: #2c2f33;
      color: var(--text);
      font-size: 16px;
    }

    input:focus, textarea:focus, select:focus {
      outline: 2px solid var(--primary);
      background: #3b4049;
    }

    button {
      background: linear-gradient(to right, var(--primary), var(--accent));
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s ease;
    }

    button:hover {
      box-shadow: 0 0 12px var(--highlight);
      transform: translateY(-2px);
    }

    .table-container, .employee-table {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      overflow-x: auto;
      margin-bottom: 40px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    thead {
      background: var(--accent);
      color: white;
    }

    .total-row {
      background: #252525;
      font-weight: bold;
    }

    .action-btn, .delete-btn, .update-btn, .export-btn, .delete-table-btn {
      padding: 8px 14px;
      margin: 5px 0;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    .delete-btn, .delete {
      background: #dc3545;
      color: white;
    }
    .update-btn, .update {
      background: #ffc107;
      color: black;
    }
    .export-btn, .export {
      background: #28a745;
      color: white;
    }
    .delete-table-btn {
      background: #6c757d;
      color: white;
    }

    .search-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .slider {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    .slides {
      display: flex;
      width: 300%;
      height: 100%;
      animation: slide 9s infinite;
    }

    .slides img {
      width: 100vw;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.75);
    }

    @keyframes slide {
      0%, 33%   { margin-left: 0; }
      36%, 66%  { margin-left: -100vw; }
      69%, 99%  { margin-left: -200vw; }
      100%      { margin-left: 0; }
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .slider {
        height: 40vh;
      }
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead { display: none; }
      tr {
        margin-bottom: 15px;
        background-color: #2a2a2a;
        padding: 10px;
        border-radius: 8px;
      }
      td {
        padding: 8px 10px;
        text-align: right;
        position: relative;
      }
      td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        color: #aaa;
        font-weight: bold;
      }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="brand">AJ Patel & Moksha Mistry Association</div>
    
    <div class="subtitle">Construction site</div>
    
    <div class="nav-right">
      
      <div class="nav-links">
        <a href="#slides">Home</a>
        <a href="#upload-form">Upload</a>
        <a href="#doc-date">Search & View Documents</a>
        <a href="#expense-form">Employee Expense</a>
         <a href="#entryForm">Client Data</a>
        <a href="/logout">Logout</a>
      </div>
    </div>
       {% if username %}
     <div style="text-align:center; font-size: 18px; margin-top: 20px;">
     ðŸ‘‹ Welcome, <strong>{{ username }}</strong>!
   </div>
{% endif %}
  </div>

  <div class="slider" id="slides">
    <div class="slides">
      <img src="/static/slide1.jpg" alt="Slide 1">
      <img src="/static/slide2.jpg" alt="Slide 2">
      <img src="/static/slide3.webp" alt="Slide 3">
    </div>
  </div>

  <div class="container">
    <!-- Upload Section -->
  <div style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; margin-bottom: 50px;">
  <!-- Upload Section -->
  <div style="flex: 1 1 400px; min-width: 320px;">
    <h2 id="upload-form">Upload Bills & Documents</h2>
    <form id="upload-form-ajax" enctype="multipart/form-data">
      <input type="text" name="name" id="doc-name" placeholder="Document Name" required>
      <input type="file" name="file" id="doc-file" required>
      <input type="date" name="date" id="doc-date-upload" required>
      <button type="submit">Upload</button>
    </form>
    <div id="upload-msg" style="text-align:center;"></div>
  </div>

  <!-- Search & View Section -->
  <div style="flex: 1 1 400px; min-width: 320px;">
    <h2>Search & View Documents</h2>
    <div class="search-bar" style="justify-content: flex-start;">
      <input type="text" id="search-name" placeholder="Search by document name...">
      <input type="date" id="doc-date">
      <button onclick="promptPasswordAndFetch()">Show Documents</button>
    </div>
    <div id="doc-list"></div>
  </div>
</div>

    <hr></hr>

    <!-- Expense Section -->
    <h2>Add Expenses</h2>
    <form id="expense-form">
      <select id="name" required>
        <option value="">--Select Employee--</option>
        <option>Ramesh</option>
        <option>Harish</option>
        <option>Elif</option>
        <option>Jigo</option>
      </select>
      <input type="number" id="amount" step="0.01" placeholder="Expense Amount (â‚¹)" required>
      <textarea id="description" placeholder="Description..." required></textarea>
      <input type="datetime-local" id="date" required>
      <button type="submit">Add Expense</button>
    </form>
    <hr></hr>
    <div id="tables"></div>
  </div>

  <hr></hr>

   <h2>Client-Employee Salary Management</h2>

  <form id="entryForm">
    <input type="text" name="client" placeholder="Client Name" required>
    <input type="number" name="rupees" placeholder="Client Rupees" id="clientRupees" required>
    <select name="employee">
      <option>Ramesh</option>
      <option>Harish</option>
      <option>Elif</option>
      <option>Jigo</option>
    </select>
    <input type="text" name="description" placeholder="Employee Description" required>
    <input type="number" name="advance" placeholder="Advance" required>
    <input type="date" name="date" required>
    <button type="submit">Add Entry</button>
  </form>

  <div id="tablesContainer"></div>






  <script>
    // Upload handling
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('upload-form-ajax').addEventListener('submit', function (e) {
        e.preventDefault();
        const files = document.getElementById('doc-file').files;
        const name = document.getElementById('doc-name').value;
        const date = document.getElementById('doc-date-upload').value;

        if (!files.length) {
          alert("Please select at least one file.");
          return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('date', date);
        for (let i = 0; i < files.length; i++) {
          formData.append('files[]', files[i]);
        }

        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          const msg = document.getElementById('upload-msg');
          if (data.success) {
            msg.innerText = 'Documents uploaded successfully.';
            msg.style.color = 'lime';
            document.getElementById('upload-form-ajax').reset();
            // optional: fetchDocuments();
          } else {
            msg.innerText = 'Upload failed: ' + (data.error || 'Unknown error');
            msg.style.color = 'red';
          }
        });
      });
    });

    function promptPasswordAndFetch() {
      const password = prompt("Enter your password:");
      if (!password) return;

      fetch("/confirm_password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          fetchDocuments();
        } else {
          alert("Incorrect password. Access denied.");
        }
      })
      .catch(() => alert("Error verifying password."));
    }

    function fetchDocuments() {
      const date = document.getElementById("doc-date").value;
      const name = document.getElementById("search-name").value.toLowerCase();

      if (!date) {
        alert("Please select a date first.");
        return;
      }

      fetch('/fetch_by_date', {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'date=' + encodeURIComponent(date)
      })
      .then(res => res.json())
      .then(data => {
        let html = `
          <div class="table-container">
            <table class="doc-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Download</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>`;

        let filtered = name ? data.filter(doc => doc[1].toLowerCase().includes(name)) : data;
  if (filtered.length === 0) {
      html += `<tr><td colspan="3" style="text-align:center;">No documents found.</td></tr>`;
    } else {
      filtered.forEach(doc => {
        const docUrl = `${location.origin}/uploads/${doc[2]}`;
        const shareLink = `https://wa.me/?text=${encodeURIComponent(`Check out this document: ${docUrl}`)}`;

        html += `
          <tr>
            <td>${doc[1]}</td>
            <td><a href="${docUrl}" target="_blank">Download</a></td>
            <td>
              <button onclick="handleUpdate(${doc[0]}, '${doc[1]}')">Update</button>
              <button onclick="deleteDocument(${doc[0]})">Delete</button>
              <a href="${shareLink}" target="_blank">
                <button>Share</button>
              </a>
              
              </td>
              </tr>`;
          });
        }

        html += `</tbody></table></div>`;
        document.getElementById("doc-list").innerHTML = html;
        document.getElementById("doc-list").scrollIntoView({ behavior: "smooth" });
      });
    }

    function deleteDocument(id) {
      if (!confirm("Are you sure you want to delete this document?")) return;

      fetch(`/delete/${id}`, {
        method: "DELETE"
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          fetchDocuments();
        } else {
          alert("Delete failed: " + (data.error || "Unknown error"));
        }
      });
    }

    function handleUpdate(id, currentName) {
      const newName = prompt("Enter new name:", currentName);
      if (!newName) return;

      const formData = new FormData();
      formData.append("new_name", newName);

      fetch(`/update/${id}`, {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          fetchDocuments();
        } else {
          alert("Update failed.");
        }
      });
    }






 document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('expense-form');
      const tables = document.getElementById('tables');

      form.addEventListener('submit', e => {
        e.preventDefault();
        const data = new FormData();
        data.append('name', document.getElementById('name').value);
        data.append('amount', document.getElementById('amount').value);
        data.append('description', document.getElementById('description').value);
        data.append('date', document.getElementById('date').value);

        fetch('/add_expense', {
          method: 'POST',
          body: data
        }).then(res => res.json()).then(() => {
          form.reset();
          loadTables();
        });
      });

      function loadTables() {
        fetch('/get_expenses')
          .then(res => res.json())
          .then(data => {
            tables.innerHTML = '';
            for (let name in data) {
              let total = 0;
              let html = `
                <div class="employee-table">
                  <h3>${name}</h3>
                  <table>
                    <thead>
                      <tr>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
              `;
              data[name].forEach(entry => {
                total += entry.amount;
                html += `
                  <tr>
                    <td data-label="amount">â‚¹${entry.amount.toFixed(2)}</td>
                    <td data-label="description">${entry.description}</td>
                    <td data-label="date">${new Date(entry.date).toLocaleString()}</td>
                    <td data-label="actions">
                      <button class="action-btn update" onclick="updateExpense(${entry.id}, ${entry.amount}, \`${entry.description}\`)">Update</button>
                      <button class="action-btn delete" onclick="deleteExpense(${entry.id})">Delete</button>
                    </td>
                  </tr>
                `;
              });
              html += `
                  <tr class="total-row">
                    <td colspan="3">Total: â‚¹${total.toFixed(2)}</td>
                    <td><a class="action-btn export" href="/export_excel/${name}" target="_blank">Export Excel</a></td>
                  </tr>
                  </tbody>
                  </table>
                </div>
              `;
              tables.innerHTML += html;
            }
          });
      }

      window.deleteExpense = function(id) {
        if (!confirm("Delete this entry?")) return;
        fetch(`/delete_expense/${id}`, { method: 'DELETE' }).then(() => loadTables());
      };

      window.updateExpense = function(id, currentAmount, currentDesc) {
        const newAmount = prompt("Enter new amount:", currentAmount);
        const newDesc = prompt("Enter new description:", currentDesc);
        if (!newAmount || !newDesc) return;

        const data = new FormData();
        data.append("amount", newAmount);
        data.append("description", newDesc);

        fetch(`/update_expense/${id}`, {
          method: 'POST',
          body: data
        }).then(() => loadTables());
      };

      loadTables();
    });













     let data = JSON.parse(localStorage.getItem("clientData")) || {};

    function saveData() {
      localStorage.setItem("clientData", JSON.stringify(data));
    }

    document.getElementById('entryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = new FormData(e.target);
      const client = form.get('client').trim();
      const rupees = parseInt(form.get('rupees'));
      const employee = form.get('employee');
      const description = form.get('description');
      const advance = parseInt(form.get('advance'));
      const date = form.get('date');

      if (!client) return alert("Client name is required.");

      if (!data[client]) {
        data[client] = { rupees: rupees || 0, employees: [] };
      }

      if (!data[client].rupees && rupees === 0) {
        const proceed = confirm("Client rupees is empty. Are you still want to add adv, you are getting in loss?");
        if (!proceed) return;
      }

      const totalAdvance = data[client].employees.reduce((sum, e) => sum + e.advance, 0);
      if (totalAdvance + advance > data[client].rupees) {
        const warn = confirm("Are you sure want to give Adv, you are getting in loss?");
        if (!warn) return;
      }

      if (data[client].employees.length === 0) {
        data[client].rupees = rupees || 0;
      }

      data[client].employees.push({ employee, description, advance, date });
      saveData();
      renderTables();
      e.target.reset();
    });

    function renderTables() {
      const container = document.getElementById('tablesContainer');
      container.innerHTML = '';

      Object.entries(data).forEach(([client, info]) => {
        const totalAdvance = info.employees.reduce((sum, emp) => sum + emp.advance, 0);
        const remaining = info.rupees - totalAdvance;
        const tableId = client.replace(/\s+/g, '') + '_table';

        let html = `<h3>${client} - â‚¹${info.rupees}</h3>`;
        html += `<table id="${tableId}"><tr>
          <th></th><th>Employee</th><th>Description</th><th>Advance</th><th>Date</th><th>Action</th>
        </tr>`;

        info.employees.forEach((emp, i) => {
          html += `<tr>
            <td>${i + 1}</td>
            <td>${emp.employee}</td>
            <td>${emp.description}</td>
            <td>â‚¹${emp.advance}</td>
            <td>${emp.date}</td>
            <td>
              <button class="delete-btn" onclick="deleteEmployee('${client}', ${i})">Delete</button>
              <button class="update-btn" onclick="updateEmployee('${client}', ${i})">Update</button>
            </td>
          </tr>`;
        });

        html += `<tr>
          <td colspan="3"><strong>Total Remaining</strong></td>
          <td colspan="3">
            â‚¹${remaining}
            <button class="export-btn" onclick="exportTable('${client}')">Export Excel</button>
            <button class="delete-table-btn" onclick="deleteTable('${client}')">Delete Table</button>
          </td>
        </tr></table><br/>`;

        container.innerHTML += html;
      });
    }

    function deleteEmployee(client, index) {
      if (confirm("Delete this employee?")) {
        data[client].employees.splice(index, 1);
        saveData();
        renderTables();
      }
    }

    function updateEmployee(client, index) {
      const emp = data[client].employees[index];
      const newDesc = prompt("Update Description:", emp.description);
      const newAdvance = parseInt(prompt("Update Advance:", emp.advance));
      const newDate = prompt("Update Date:", emp.date);

      if (!isNaN(newAdvance)) {
        const totalOther = data[client].employees.reduce((sum, e, i) => i !== index ? sum + e.advance : sum, 0);
        if (totalOther + newAdvance > data[client].rupees) {
          if (!confirm("Advance exceeds client rupees. Continue?")) return;
        }

        emp.description = newDesc || emp.description;
        emp.advance = newAdvance;
        emp.date = newDate || emp.date;
        saveData();
        renderTables();
      }
    }

    function deleteTable(client) {
      if (confirm("Delete entire client table and all employee records?")) {
        delete data[client];
        saveData();
        renderTables();
      }
    }

function exportTable(client) {
  const empData = data[client].employees;
  let csv = "Employee,Description,Advance,Date\n";

  empData.forEach(emp => {
    const formattedDate = emp.date
      ? new Date(emp.date).toLocaleDateString('en-GB')
      : '';
    csv += `${emp.employee},${emp.description},${emp.advance},${formattedDate}\n`;
  });

  const total = data[client].rupees - empData.reduce((sum, e) => sum + e.advance, 0);
  csv += `,,Total Rem,${total}\n`;

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `${client}_salary_report.csv`;
  link.click();
}


    // Load on page
    renderTables();

  </script>
</body>
</html>
